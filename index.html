<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ava Force ðŸ”¥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            background: #0a0a0a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Main container - full screen */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        /* Game Canvas Area - Takes most of the screen */
        #game-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #1a0a2e 0%, #0a0a1a 50%, #000 100%);
            overflow: hidden;
            min-height: 0; /* Important for flex child */
        }

        #game-canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 20px rgba(255, 0, 100, 0.3);
        }

        /* CRT Effect Overlay */
        #crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            z-index: 10;
        }

        /* UI HUD - Inside game area, not overlapping controls */
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            z-index: 20;
            pointer-events: none;
        }

        .hud-section {
            display: flex;
            gap: 15px;
        }

        .hud-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hud-label {
            color: #ff6b9d;
        }

        .hud-value {
            color: #fff;
        }

        /* Controls Section - Fixed at bottom, separate from game */
        #controls {
            height: 140px;
            min-height: 140px;
            max-height: 140px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-top: 2px solid #ff6b9d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            gap: 20px;
            flex-shrink: 0;
            z-index: 30;
        }

        /* D-Pad */
        .dpad {
            display: grid;
            grid-template-columns: 50px 50px 50px;
            grid-template-rows: 50px 50px;
            gap: 2px;
        }

        .dpad-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 2px solid #444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #888;
            cursor: pointer;
            transition: all 0.1s;
        }

        .dpad-btn:active {
            background: linear-gradient(145deg, #3a3a4e, #2a2a3e);
            border-color: #ff6b9d;
            color: #ff6b9d;
            transform: scale(0.95);
        }

        .dpad-btn:empty { pointer-events: none; }

        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .action-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        #btn-fire {
            background: linear-gradient(145deg, #ff6b9d, #c44569);
            border: 3px solid #ff8fab;
        }

        #btn-fire:active {
            background: linear-gradient(145deg, #ff8fab, #ff6b9d);
        }

        #btn-special {
            background: linear-gradient(145deg, #4ecdc4, #44a3aa);
            border: 3px solid #7fdbda;
        }

        #btn-special:active {
            background: linear-gradient(145deg, #7fdbda, #4ecdc4);
        }

        /* Start/Game Over Overlay */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        .overlay.hidden {
            display: none;
        }

        .overlay h1 {
            color: #ff6b9d;
            font-size: 42px;
            text-shadow: 4px 4px 0 #c44569;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .overlay p {
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.6;
        }

        .overlay-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(145deg, #ff6b9d, #c44569);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
            transition: all 0.2s;
        }

        .overlay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.6);
        }

        .overlay-btn:active {
            transform: translateY(0);
        }

        /* Responsive */
        @media (max-height: 600px) {
            #controls {
                height: 100px;
                min-height: 100px;
                max-height: 100px;
                padding: 5px 15px;
            }

            .dpad-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .action-btn {
                width: 55px;
                height: 55px;
                font-size: 14px;
            }
        }

        @media (max-width: 350px) {
            #controls {
                padding: 5px 10px;
            }

            .dpad {
                grid-template-columns: 45px 45px 45px;
                grid-template-rows: 45px 45px;
            }

            .dpad-btn {
                width: 45px;
                height: 45px;
            }

            .action-btn {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Game Area -->
        <div id="game-wrapper">
            <canvas id="game-canvas" width="320" height="224"></canvas>
            <div id="crt-overlay"></div>
            
            <!-- HUD -->
            <div id="hud">
                <div class="hud-section">
                    <div class="hud-item">
                        <span class="hud-label">SCORE</span>
                        <span class="hud-value" id="score">000000</span>
                    </div>
                </div>
                <div class="hud-section">
                    <div class="hud-item">
                        <span class="hud-label">LIVES</span>
                        <span class="hud-value" id="lives">3</span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">WPN</span>
                        <span class="hud-value" id="weapon">N</span>
                    </div>
                </div>
            </div>

            <!-- Start Screen -->
            <div class="overlay" id="overlay">
                <h1>ðŸ”¥ AVA FORCE</h1>
                <p>Run and gun action!<br>Collect power-ups, defeat enemies!</p>
                <button class="overlay-btn" id="start-btn">START GAME</button>
            </div>

            <!-- Game Over Screen -->
            <div class="overlay hidden" id="game-over">
                <h1>GAME OVER</h1>
                <p id="final-score">SCORE: 000000</p>
                <button class="overlay-btn" id="restart-btn">PLAY AGAIN</button>
            </div>
        </div>

        <!-- Controls Section - Completely separate from game area -->
        <div id="controls">
            <div class="dpad">
                <div class="dpad-btn" id="btn-up">â–²</div>
                <div class="dpad-btn" id="btn-left">â—€</div>
                <div class="dpad-btn" id="btn-down">â–¼</div>
                <div class="dpad-btn" id="btn-right">â–¶</div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="btn-fire">FIRE</button>
                <button class="action-btn" id="btn-special">SPC</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Game Constants
        const CANVAS_WIDTH = 320;
        const CANVAS_HEIGHT = 224;
        const GRAVITY = 0.5;
        const JUMP_FORCE = -8;
        const MOVE_SPEED = 3;
        const BULLET_SPEED = 6;

        // Canvas Setup
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Game State
        let gameRunning = false;
        let score = 0;
        let lives = 3;
        let frame = 0;
        let levelScroll = 0;

        // Input State
        const keys = {
            up: false,
            down: false,
            left: false,
            right: false,
            fire: false,
            special: false
        };

        // Game Objects
        let player;
        let bullets = [];
        let enemies = [];
        let powerUps = [];
        let particles = [];

        // Player Class
        class Player {
            constructor() {
                this.x = 50;
                this.y = CANVAS_HEIGHT - 60;
                this.width = 16;
                this.height = 24;
                this.vx = 0;
                this.vy = 0;
                this.grounded = false;
                this.weapon = 'normal';
                this.invulnerable = 0;
                this.facing = 1;
            }

            update() {
                // Horizontal movement
                if (keys.left) {
                    this.vx = -MOVE_SPEED;
                    this.facing = -1;
                } else if (keys.right) {
                    this.vx = MOVE_SPEED;
                    this.facing = 1;
                } else {
                    this.vx *= 0.8;
                }

                // Jump
                if (keys.up && this.grounded) {
                    this.vy = JUMP_FORCE;
                    this.grounded = false;
                }

                // Apply gravity
                this.vy += GRAVITY;

                // Update position
                this.x += this.vx;
                this.y += this.vy;

                // Floor collision
                if (this.y + this.height > CANVAS_HEIGHT - 20) {
                    this.y = CANVAS_HEIGHT - 20 - this.height;
                    this.vy = 0;
                    this.grounded = true;
                }

                // Screen boundaries
                if (this.x < 0) this.x = 0;
                if (this.x > CANVAS_WIDTH - this.width) this.x = CANVAS_WIDTH - this.width;

                // Fire weapon
                if (keys.fire && frame % 10 === 0) {
                    this.fire();
                }

                // Death plane - fall off world
                if (this.y > CANVAS_HEIGHT) {
                    this.die();
                }

                // Invulnerability countdown
                if (this.invulnerable > 0) this.invulnerable--;
            }

            fire() {
                if (this.weapon === 'spread') {
                    bullets.push(new Bullet(this.x + this.width/2, this.y + 8, 6, 0));
                    bullets.push(new Bullet(this.x + this.width/2, this.y + 8, 5, -2));
                    bullets.push(new Bullet(this.x + this.width/2, this.y + 8, 5, 2));
                } else if (this.weapon === 'laser') {
                    bullets.push(new Bullet(this.x + this.width/2, this.y + 8, 10, 0, 'laser'));
                } else if (this.weapon === 'rapid') {
                    bullets.push(new Bullet(this.x + this.width/2, this.y + 8, 8, 0));
                    if (frame % 5 === 0) {
                        bullets.push(new Bullet(this.x + this.width/2, this.y + 4, 8, 0));
                    }
                } else {
                    bullets.push(new Bullet(this.x + this.width/2, this.y + 8, 6, 0));
                }
            }

            draw() {
                if (this.invulnerable > 0 && frame % 4 < 2) return;

                // Body
                ctx.fillStyle = '#ff6b9d';
                ctx.fillRect(this.x + 4, this.y + 8, 8, 12);

                // Head
                ctx.fillStyle = '#ffcccc';
                ctx.fillRect(this.x + 4, this.y, 8, 8);

                // Hair
                ctx.fillStyle = '#ff1493';
                ctx.fillRect(this.x + 2, this.y, 12, 4);
                ctx.fillRect(this.x, this.y + 2, 4, 6);

                // Eye
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x + (this.facing > 0 ? 10 : 6), this.y + 3, 2, 2);

                // Legs (animated)
                ctx.fillStyle = '#2d1b4e';
                if (Math.abs(this.vx) > 0.5) {
                    const legOffset = Math.sin(frame * 0.3) * 3;
                    ctx.fillRect(this.x + 4, this.y + 20, 3, 4 + legOffset);
                    ctx.fillRect(this.x + 9, this.y + 20, 3, 4 - legOffset);
                } else {
                    ctx.fillRect(this.x + 4, this.y + 20, 3, 4);
                    ctx.fillRect(this.x + 9, this.y + 20, 3, 4);
                }

                // Weapon
                ctx.fillStyle = '#4ecdc4';
                ctx.fillRect(this.x + (this.facing > 0 ? 12 : 2), this.y + 10, 6, 3);
            }

            die() {
                // Reset player to spawn point when falling off world
                this.x = 50;
                this.y = 50;
                this.vx = 0;
                this.vy = 0;
                this.invulnerable = 120;
                createParticles(this.x, this.y, 20, "#ff6b9d");
                // Lose a life
                lives--;
                if (lives <= 0) {
                    gameOver();
                }
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred("error");
                }
            }

            hit() {
                if (this.invulnerable > 0) return false;
                this.invulnerable = 60;
                createParticles(this.x + 8, this.y + 12, 10, '#ff6b9d');
                return true;
            }
        }

        // Bullet Class
        class Bullet {
            constructor(x, y, vx, vy, type = 'normal') {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.width = 8;
                this.height = 4;
                this.type = type;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
            }

            draw() {
                if (this.type === 'laser') {
                    ctx.fillStyle = '#00ff00';
                    ctx.fillRect(this.x, this.y - 1, 16, 3);
                    ctx.fillStyle = '#ccffcc';
                    ctx.fillRect(this.x, this.y, 12, 1);
                } else {
                    ctx.fillStyle = '#ffff00';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(this.x + 2, this.y + 1, 4, 2);
                }
            }

            isOffScreen() {
                return this.x > CANVAS_WIDTH || this.x < 0 || this.y > CANVAS_HEIGHT || this.y < 0;
            }
        }

        // Enemy Class
        class Enemy {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = 16;
                this.height = 16;
                this.hp = type === 'tank' ? 3 : 1;
                this.vx = type === 'flying' ? -2 : -1;
                this.vy = 0;
                this.startY = y;
            }

            update() {
                this.x += this.vx;

                if (this.type === 'flying') {
                    this.y = this.startY + Math.sin(frame * 0.05) * 20;
                }
            }

            draw() {
                if (this.type === 'tank') {
                    // Tank body
                    ctx.fillStyle = '#8b0000';
                    ctx.fillRect(this.x, this.y + 4, 16, 12);
                    // Turret
                    ctx.fillStyle = '#a52a2a';
                    ctx.fillRect(this.x + 4, this.y, 8, 8);
                    // Tracks
                    ctx.fillStyle = '#333';
                    ctx.fillRect(this.x - 2, this.y + 12, 4, 6);
                    ctx.fillRect(this.x + 14, this.y + 12, 4, 6);
                } else if (this.type === 'flying') {
                    // Drone body
                    ctx.fillStyle = '#4a0080';
                    ctx.fillRect(this.x + 4, this.y + 4, 8, 8);
                    // Rotors
                    ctx.fillStyle = '#666';
                    const rotorOffset = Math.sin(frame * 0.5) * 3;
                    ctx.fillRect(this.x, this.y + 6 + rotorOffset, 4, 2);
                    ctx.fillRect(this.x + 12, this.y + 6 - rotorOffset, 4, 2);
                } else {
                    // Grunt
                    ctx.fillStyle = '#2d5016';
                    ctx.fillRect(this.x + 2, this.y, 12, 14);
                    // Head
                    ctx.fillStyle = '#4a7c2e';
                    ctx.fillRect(this.x + 4, this.y + 2, 8, 6);
                    // Eyes
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(this.x + 5, this.y + 4, 2, 2);
                    ctx.fillRect(this.x + 9, this.y + 4, 2, 2);
                }
            }

            isOffScreen() {
                return this.x < -20;
            }
        }

        // PowerUp Class
        class PowerUp {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = 16;
                this.height = 16;
                this.vy = -2;
                this.startX = x;
            }

            update() {
                this.x = this.startX + Math.sin(frame * 0.05) * 10;
                this.y += this.vy;
                if (this.y < CANVAS_HEIGHT - 80) this.vy = 0.5;
                if (this.y > CANVAS_HEIGHT - 40) this.vy = -0.5;
            }

            draw() {
                const colors = { S: '#ff6b6b', L: '#4ecdc4', R: '#ffd93d', '1UP': '#95e1d3' };
                ctx.fillStyle = colors[this.type] || '#fff';
                ctx.fillRect(this.x + 2, this.y + 2, 12, 12);
                ctx.fillStyle = '#fff';
                ctx.font = '10px monospace';
                ctx.fillText(this.type, this.x + 4, this.y + 12);
                
                // Glow
                ctx.strokeStyle = colors[this.type];
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x, this.y, 16, 16);
            }

            isOffScreen() {
                return this.x < -20;
            }
        }

        // Particle Class
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 6;
                this.vy = (Math.random() - 0.5) * 6;
                this.life = 30;
                this.color = color;
                this.size = Math.random() * 4 + 2;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2;
                this.life--;
                this.size *= 0.95;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 30;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }

        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // Enemy Spawning
        function spawnEnemies() {
            if (frame % 120 === 0) {
                const rand = Math.random();
                let type = 'grunt';
                if (rand > 0.7) type = 'flying';
                if (rand > 0.9) type = 'tank';
                
                const y = type === 'flying' ? CANVAS_HEIGHT - 100 - Math.random() * 60 : CANVAS_HEIGHT - 40;
                enemies.push(new Enemy(CANVAS_WIDTH + 20, y, type));
            }
        }

        // Collision Detection
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        // Draw background
        function drawBackground() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, CANVAS_HEIGHT);
            gradient.addColorStop(0, '#1a0a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Parallax mountains
            ctx.fillStyle = '#0a0a1a';
            for (let i = 0; i < 5; i++) {
                const x = ((i * 80 - levelScroll * 0.2) % (CANVAS_WIDTH + 80)) - 40;
                ctx.beginPath();
                ctx.moveTo(x, CANVAS_HEIGHT - 20);
                ctx.lineTo(x + 40, CANVAS_HEIGHT - 80);
                ctx.lineTo(x + 80, CANVAS_HEIGHT - 20);
                ctx.fill();
            }

            // Ground
            ctx.fillStyle = '#2d1b4e';
            ctx.fillRect(0, CANVAS_HEIGHT - 20, CANVAS_WIDTH, 20);
            
            // Ground details
            ctx.fillStyle = '#3d2b5e';
            for (let i = 0; i < CANVAS_WIDTH; i += 20) {
                const x = (i - levelScroll) % CANVAS_WIDTH;
                ctx.fillRect(x, CANVAS_HEIGHT - 20, 10, 5);
            }
        }

        // Game Loop
        function update() {
            if (!gameRunning) return;

            frame++;
            levelScroll += 1;

            // Update player
            player.update();

            // Spawn enemies
            spawnEnemies();

            // Update bullets
            bullets = bullets.filter(b => {
                b.update();
                return !b.isOffScreen();
            });

            // Update enemies
            enemies = enemies.filter(e => {
                e.update();

                // Check bullet collisions
                for (let i = bullets.length - 1; i >= 0; i--) {
                    if (checkCollision(bullets[i], e)) {
                        bullets.splice(i, 1);
                        e.hp--;
                        createParticles(e.x + 8, e.y + 8, 5, '#ff6b6b');

                        if (e.hp <= 0) {
                            score += e.type === 'tank' ? 500 : e.type === 'flying' ? 200 : 100;
                            createParticles(e.x + 8, e.y + 8, 15, '#ff6b6b');
                            
                            // Chance to spawn power-up
                            if (Math.random() < 0.15) {
                                const types = ['S', 'L', 'R'];
                                const type = types[Math.floor(Math.random() * types.length)];
                                powerUps.push(new PowerUp(e.x, e.y, type));
                            }
                            
                            return false;
                        }
                    }
                }

                // Check player collision
                if (checkCollision(player, e)) {
                    if (player.hit()) {
                        lives--;
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('error');
                        }
                        if (lives <= 0) {
                            gameOver();
                        }
                    }
                }

                return !e.isOffScreen();
            });

            // Update power-ups
            powerUps = powerUps.filter(p => {
                p.update();

                if (checkCollision(player, p)) {
                    if (p.type === 'S') player.weapon = 'spread';
                    else if (p.type === 'L') player.weapon = 'laser';
                    else if (p.type === 'R') player.weapon = 'rapid';
                    else if (p.type === '1UP') lives++;

                    score += 50;
                    createParticles(p.x + 8, p.y + 8, 10, '#ffd700');
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                    return false;
                }

                return !p.isOffScreen();
            });

            // Update particles
            particles = particles.filter(p => {
                p.update();
                return p.life > 0;
            });

            // Update HUD
            document.getElementById('score').textContent = score.toString().padStart(6, '0');
            document.getElementById('lives').textContent = lives;
            document.getElementById('weapon').textContent = player.weapon === 'normal' ? 'N' : player.weapon.toUpperCase()[0];
        }

        function draw() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            drawBackground();

            // Draw game objects
            powerUps.forEach(p => p.draw());
            enemies.forEach(e => e.draw());
            bullets.forEach(b => b.draw());
            if (player) player.draw();
            particles.forEach(p => p.draw());
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameRunning = true;
            score = 0;
            lives = 3;
            frame = 0;
            levelScroll = 0;

            player = new Player();
            bullets = [];
            enemies = [];
            powerUps = [];
            particles = [];

            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('game-over').style.display = 'none';
        }

        function gameOver() {
            gameRunning = false;
            document.getElementById('final-score').textContent = 'SCORE: ' + score.toString().padStart(6, '0');
            document.getElementById('game-over').style.display = 'flex';

            // Save high score
            if (tg?.CloudStorage) {
                tg.CloudStorage.getItem('avaforce_highscore', (err, val) => {
                    const highScore = val ? parseInt(val) : 0;
                    if (score > highScore) {
                        tg.CloudStorage.setItem('avaforce_highscore', score.toString());
                    }
                });
            }
        }

        // Touch Controls Setup
        function setupTouchControls() {
            const buttons = {
                'btn-up': 'up',
                'btn-down': 'down',
                'btn-left': 'left',
                'btn-right': 'right',
                'btn-fire': 'fire',
                'btn-special': 'special'
            };

            for (const [btnId, key] of Object.entries(buttons)) {
                const btn = document.getElementById(btnId);
                
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    keys[key] = true;
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });

                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    keys[key] = false;
                });

                // Mouse fallback for desktop testing
                btn.addEventListener('mousedown', (e) => {
                    keys[key] = true;
                });

                btn.addEventListener('mouseup', (e) => {
                    keys[key] = false;
                });
            }
        }

        // Keyboard Controls
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp': case 'w': keys.up = true; break;
                case 'ArrowDown': case 's': keys.down = true; break;
                case 'ArrowLeft': case 'a': keys.left = true; break;
                case 'ArrowRight': case 'd': keys.right = true; break;
                case ' ': case 'z': keys.fire = true; break;
                case 'x': case 'Shift': keys.special = true; break;
            }
        });

        document.addEventListener('keyup', (e) => {
            switch(e.key) {
                case 'ArrowUp': case 'w': keys.up = false; break;
                case 'ArrowDown': case 's': keys.down = false; break;
                case 'ArrowLeft': case 'a': keys.left = false; break;
                case 'ArrowRight': case 'd': keys.right = false; break;
                case ' ': case 'z': keys.fire = false; break;
                case 'x': case 'Shift': keys.special = false; break;
            }
        });

        // Event Listeners
        document.getElementById('start-btn').addEventListener('click', () => {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            startGame();
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            startGame();
        });

        // Initialize
        setupTouchControls();
        gameLoop();
    </script>
</body>
</html>