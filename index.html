<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ava Force üî•</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: #0a0a0a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #game-container {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        /* Game Canvas Area - Takes most of the screen */
        #game-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #1a0a2e 0%, #0a0a1a 50%, #000 100%);
            overflow: hidden;
        }

        #game-canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 20px rgba(255, 0, 100, 0.3);
        }

        /* CRT Effect Overlay */
        #crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            z-index: 10;
        }

        /* UI HUD - Inside game area, not overlapping controls */
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            z-index: 20;
            pointer-events: none;
        }

        .hud-section {
            display: flex;
            gap: 15px;
        }

        .hud-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hud-label {
            color: #ff6b9d;
        }

        .hud-value {
            color: #fff;
        }

        .weapon-icon {
            color: #4ecdc4;
        }

        /* Controls Container - Fixed at bottom */
        #controls {
            height: 140px;
            min-height: 140px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-top: 2px solid #ff6b9d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            gap: 20px;
            z-index: 30;
        }

        /* D-Pad */
        .dpad {
            display: grid;
            grid-template-columns: 50px 50px 50px;
            grid-template-rows: 50px 50px;
            gap: 2px;
        }

        .dpad-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 2px solid #444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #888;
            cursor: pointer;
            transition: all 0.1s;
        }

        .dpad-btn:active, .dpad-btn.active {
            background: linear-gradient(145deg, #ff6b9d, #c44569);
            border-color: #ff6b9d;
            color: #fff;
            transform: scale(0.95);
        }

        .dpad-btn:nth-child(2) { grid-column: 2; }
        .dpad-btn:nth-child(1) { grid-column: 1; grid-row: 2; }
        .dpad-btn:nth-child(3) { grid-column: 2; grid-row: 2; }
        .dpad-btn:nth-child(4) { grid-column: 3; grid-row: 2; }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .action-btn:active, .action-btn.active {
            transform: scale(0.9);
        }

        .btn-jump {
            background: linear-gradient(145deg, #4ecdc4, #44a3aa);
            border-color: #4ecdc4;
            color: #fff;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn-jump:active, .btn-jump.active {
            background: #3dbdb4;
            box-shadow: 0 0 20px #4ecdc4;
        }

        .btn-shoot {
            background: linear-gradient(145deg, #ff6b9d, #c44569);
            border-color: #ff6b9d;
            color: #fff;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn-shoot:active, .btn-shoot.active {
            background: #e55a8c;
            box-shadow: 0 0 20px #ff6b9d;
        }

        .btn-label {
            font-size: 10px;
            opacity: 0.8;
        }

        /* Start/Pause overlay */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        #overlay h1 {
            font-size: 48px;
            color: #ff6b9d;
            text-shadow: 
                0 0 10px #ff6b9d,
                3px 3px 0 #c44569;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        #overlay h2 {
            font-size: 18px;
            color: #4ecdc4;
            margin-bottom: 30px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .start-btn {
            padding: 15px 40px;
            font-size: 20px;
            background: linear-gradient(145deg, #ff6b9d, #c44569);
            border: none;
            border-radius: 30px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.4);
            transition: all 0.2s;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 107, 157, 0.6);
        }

        .instructions {
            margin-top: 20px;
            color: #888;
            font-size: 12px;
            text-align: center;
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        /* Game Over Screen */
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }

        #game-over h2 {
            font-size: 36px;
            color: #ff6b9d;
            margin-bottom: 20px;
        }

        #final-score {
            font-size: 24px;
            color: #fff;
            margin-bottom: 30px;
        }

        /* Landscape optimization */
        @media (orientation: landscape) and (max-height: 500px) {
            #controls {
                height: 100px;
                min-height: 100px;
            }

            .dpad-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .action-btn {
                width: 55px;
                height: 55px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-wrapper">
            <canvas id="game-canvas" width="320" height="224"></canvas>
            <div id="crt-overlay"></div>
            
            <!-- HUD -->
            <div id="hud">
                <div class="hud-section">
                    <div class="hud-item">
                        <span class="hud-label">SCORE</span>
                        <span class="hud-value" id="score">000000</span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">LIVES</span>
                        <span class="hud-value" id="lives">3</span>
                    </div>
                </div>
                <div class="hud-section">
                    <div class="hud-item">
                        <span class="weapon-icon" id="weapon">N</span>
                    </div>
                </div>
            </div>

            <!-- Start Overlay -->
            <div id="overlay">
                <h1>üî• AVA FORCE üî•</h1>
                <h2>RED HOT RUN 'N GUN</h2>
                <button class="start-btn" id="start-btn">INSERT COIN</button>
                <div class="instructions">
                    ‚óÄ ‚ñ∂ MOVE ‚Ä¢ ‚ñ≤ JUMP ‚Ä¢ ‚óè SHOOT<br>
                    Collect power-ups! Destroy enemies!
                </div>
            </div>

            <!-- Game Over Screen -->
            <div id="game-over">
                <h2>GAME OVER</h2>
                <div id="final-score">SCORE: 0</div>
                <button class="start-btn" id="restart-btn">CONTINUE?</button>
            </div>
        </div>

        <!-- Touch Controls -->
        <div id="controls">
            <div class="dpad">
                <div class="dpad-btn" id="btn-up">‚ñ≤</div>
                <div class="dpad-btn" id="btn-left">‚óÄ</div>
                <div class="dpad-btn" id="btn-down">‚ñº</div>
                <div class="dpad-btn" id="btn-right">‚ñ∂</div>
            </div>

            <div class="action-buttons">
                <div class="action-btn btn-jump" id="btn-jump">
                    <span>JUMP</span>
                </div>
                <div class="action-btn btn-shoot" id="btn-shoot">
                    <span>FIRE</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation();
        }

        // Game Constants
        const CANVAS_WIDTH = 320;
        const CANVAS_HEIGHT = 224;
        const GRAVITY = 0.4;
        const JUMP_FORCE = -7;
        const MOVE_SPEED = 2;
        const BULLET_SPEED = 6;

        // Canvas Setup
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Scale canvas for retro look but maintain aspect ratio
        function resizeCanvas() {
            const wrapper = document.getElementById('game-wrapper');
            const aspectRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
            const wrapperAspect = wrapper.clientWidth / wrapper.clientHeight;

            if (wrapperAspect > aspectRatio) {
                canvas.style.height = wrapper.clientHeight + 'px';
                canvas.style.width = (wrapper.clientHeight * aspectRatio) + 'px';
            } else {
                canvas.style.width = wrapper.clientWidth + 'px';
                canvas.style.height = (wrapper.clientWidth / aspectRatio) + 'px';
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Disable context menu
        canvas.addEventListener('contextmenu', e => e.preventDefault());

        // Game State
        let gameRunning = false;
        let score = 0;
        let lives = 3;
        let frame = 0;
        let levelScroll = 0;

        // Input State
        const keys = {
            left: false,
            right: false,
            up: false,
            down: false,
            jump: false,
            shoot: false
        };

        // Touch Controls Setup
        function setupTouchButton(id, key) {
            const btn = document.getElementById(id);
            
            const startHandler = (e) => {
                e.preventDefault();
                keys[key] = true;
                btn.classList.add('active');
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            };
            
            const endHandler = (e) => {
                e.preventDefault();
                keys[key] = false;
                btn.classList.remove('active');
            };

            btn.addEventListener('touchstart', startHandler, {passive: false});
            btn.addEventListener('touchend', endHandler, {passive: false});
            btn.addEventListener('mousedown', startHandler);
            btn.addEventListener('mouseup', endHandler);
            btn.addEventListener('mouseleave', endHandler);
        }

        setupTouchButton('btn-left', 'left');
        setupTouchButton('btn-right', 'right');
        setupTouchButton('btn-up', 'up');
        setupTouchButton('btn-down', 'down');
        setupTouchButton('btn-jump', 'jump');
        setupTouchButton('btn-shoot', 'shoot');

        // Keyboard Controls
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft': case 'a': keys.left = true; break;
                case 'ArrowRight': case 'd': keys.right = true; break;
                case 'ArrowUp': case 'w': keys.up = true; break;
                case 'ArrowDown': case 's': keys.down = true; break;
                case ' ': case 'z': keys.jump = true; break;
                case 'x': case 'Shift': keys.shoot = true; break;
            }
        });

        document.addEventListener('keyup', (e) => {
            switch(e.key) {
                case 'ArrowLeft': case 'a': keys.left = false; break;
                case 'ArrowRight': case 'd': keys.right = false; break;
                case 'ArrowUp': case 'w': keys.up = false; break;
                case 'ArrowDown': case 's': keys.down = false; break;
                case ' ': case 'z': keys.jump = false; break;
                case 'x': case 'Shift': keys.shoot = false; break;
            }
        });

        // Game Objects
        class Player {
            constructor() {
                this.x = 50;
                this.y = 150;
                this.vx = 0;
                this.vy = 0;
                this.width = 16;
                this.height = 24;
                this.onGround = false;
                this.facingRight = true;
                this.weapon = 'normal'; // normal, spread, laser, rapid
                this.shootTimer = 0;
                this.invulnerable = 0;
                this.animFrame = 0;
            }

            update() {
                // Movement
                if (keys.left) {
                    this.vx = -MOVE_SPEED;
                    this.facingRight = false;
                } else if (keys.right) {
                    this.vx = MOVE_SPEED;
                    this.facingRight = true;
                } else {
                    this.vx *= 0.8;
                }

                // Jump
                if (keys.jump && this.onGround) {
                    this.vy = JUMP_FORCE;
                    this.onGround = false;
                    createParticles(this.x + 8, this.y + 24, 5, '#4ecdc4');
                }

                // Gravity
                this.vy += GRAVITY;

                // Update position
                this.x += this.vx;
                this.y += this.vy;

                // Ground collision
                if (this.y + this.height > CANVAS_HEIGHT - 20) {
                    this.y = CANVAS_HEIGHT - 20 - this.height;
                    this.vy = 0;
                    this.onGround = true;
                }

                // Screen bounds
                this.x = Math.max(0, Math.min(this.x, CANVAS_WIDTH - this.width));

                // Shooting
                if (this.shootTimer > 0) this.shootTimer--;
                if (keys.shoot && this.shootTimer <= 0) {
                    this.shoot();
                    this.shootTimer = this.weapon === 'rapid' ? 5 : 12;
                }

                // Invulnerability
                if (this.invulnerable > 0) this.invulnerable--;

                // Animation
                if (Math.abs(this.vx) > 0.1 && this.onGround) {
                    this.animFrame = (this.animFrame + 0.2) % 4;
                }
            }

            shoot() {
                const bulletY = this.y + 10;
                const bulletX = this.facingRight ? this.x + this.width : this.x;
                const dir = this.facingRight ? 1 : -1;

                if (this.weapon === 'spread') {
                    bullets.push(new Bullet(bulletX, bulletY - 3, dir, -0.3));
                    bullets.push(new Bullet(bulletX, bulletY, dir, 0));
                    bullets.push(new Bullet(bulletX, bulletY + 3, dir, 0.3));
                } else if (this.weapon === 'laser') {
                    bullets.push(new Bullet(bulletX, bulletY, dir * 2, 0, true));
                } else {
                    bullets.push(new Bullet(bulletX, bulletY, dir, 0));
                }

                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            }

            draw() {
                if (this.invulnerable > 0 && Math.floor(frame / 4) % 2 === 0) return;

                ctx.save();
                
                // Draw Ava - red outfit, red hair
                const x = Math.floor(this.x);
                const y = Math.floor(this.y);

                // Body (red outfit)
                ctx.fillStyle = '#c44569';
                ctx.fillRect(x + 4, y + 8, 8, 12);

                // Legs
                ctx.fillStyle = '#2a2a3e';
                if (Math.abs(this.vx) > 0.1 && this.onGround) {
                    const legOffset = Math.sin(this.animFrame * Math.PI / 2) * 3;
                    ctx.fillRect(x + 3, y + 20, 4, 4 + legOffset);
                    ctx.fillRect(x + 9, y + 20, 4, 4 - legOffset);
                } else {
                    ctx.fillRect(x + 3, y + 20, 4, 4);
                    ctx.fillRect(x + 9, y + 20, 4, 4);
                }

                // Red hair
                ctx.fillStyle = '#ff6b6b';
                ctx.fillRect(x + 2, y, 12, 6);
                ctx.fillRect(x, y + 2, 2, 8); // Long hair side
                ctx.fillRect(x + 14, y + 2, 2, 8);

                // Head
                ctx.fillStyle = '#f4d03f';
                ctx.fillRect(x + 4, y + 2, 8, 7);

                // Eyes (blue)
                ctx.fillStyle = '#4ecdc4';
                if (this.facingRight) {
                    ctx.fillRect(x + 9, y + 4, 2, 2);
                } else {
                    ctx.fillRect(x + 5, y + 4, 2, 2);
                }

                // Gun
                ctx.fillStyle = '#888';
                if (this.facingRight) {
                    ctx.fillRect(x + 12, y + 10, 6, 3);
                } else {
                    ctx.fillRect(x - 2, y + 10, 6, 3);
                }

                ctx.restore();
            }

            hit() {
                if (this.invulnerable > 0) return false;
                this.invulnerable = 60;
                createParticles(this.x + 8, this.y + 12, 10, '#ff6b6b');
                return true;
            }
        }

        class Bullet {
            constructor(x, y, vx, vy, isLaser = false) {
                this.x = x;
                this.y = y;
                this.vx = vx * BULLET_SPEED;
                this.vy = vy * BULLET_SPEED;
                this.isLaser = isLaser;
                this.width = isLaser ? 16 : 4;
                this.height = isLaser ? 2 : 2;
                this.lifetime = 60;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.lifetime--;
            }

            draw() {
                ctx.fillStyle = this.isLaser ? '#00ff00' : '#ffff00';
                if (this.isLaser) {
                    ctx.fillRect(Math.floor(this.x), Math.floor(this.y) - 1, this.width, this.height);
                } else {
                    ctx.fillRect(Math.floor(this.x), Math.floor(this.y), this.width, this.height);
                }
            }

            isOffScreen() {
                return this.x < 0 || this.x > CANVAS_WIDTH || this.y < 0 || this.y > CANVAS_HEIGHT || this.lifetime <= 0;
            }
        }

        class Enemy {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type; // 'grunt', 'flying', 'tank'
                this.vx = type === 'flying' ? -1.5 : -1;
                this.vy = 0;
                this.width = type === 'tank' ? 24 : 16;
                this.height = type === 'tank' ? 16 : 16;
                this.hp = type === 'tank' ? 3 : 1;
                this.animFrame = 0;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.animFrame += 0.1;

                if (this.type === 'flying') {
                    this.y += Math.sin(this.animFrame) * 0.5;
                }
            }

            draw() {
                const x = Math.floor(this.x);
                const y = Math.floor(this.y);

                if (this.type === 'grunt') {
                    // Robot soldier
                    ctx.fillStyle = '#556';
                    ctx.fillRect(x + 2, y + 2, 12, 12);
                    ctx.fillStyle = '#f44';
                    ctx.fillRect(x + 5, y + 5, 6, 3); // Eye
                } else if (this.type === 'flying') {
                    // Drone
                    ctx.fillStyle = '#7b68ee';
                    ctx.fillRect(x, y + 4, 16, 8);
                    ctx.fillStyle = '#f44';
                    ctx.fillRect(x + 4, y + 6, 8, 4);
                    // Propeller
                    if (Math.floor(this.animFrame * 10) % 2 === 0) {
                        ctx.fillStyle = '#888';
                        ctx.fillRect(x - 4, y + 6, 24, 2);
                    }
                } else if (this.type === 'tank') {
                    // Tank
                    ctx.fillStyle = '#4a4';
                    ctx.fillRect(x, y + 4, 24, 12);
                    ctx.fillStyle = '#2a2';
                    ctx.fillRect(x + 4, y, 16, 8); // Turret
                    // Tread animation
                    ctx.fillStyle = '#222';
                    ctx.fillRect(x + 2 + (Math.floor(this.animFrame) % 2) * 2, y + 14, 20, 2);
                }
            }

            isOffScreen() {
                return this.x < -32;
            }
        }

        class PowerUp {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type; // 'S', 'L', 'R', '1UP'
                this.vy = -2;
                this.vx = -0.5;
                this.bob = 0;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.05;
                this.bob += 0.1;

                // Floor bounce
                if (this.y > CANVAS_HEIGHT - 30) {
                    this.y = CANVAS_HEIGHT - 30;
                    this.vy = -1;
                }
            }

            draw() {
                const x = Math.floor(this.x);
                const y = Math.floor(this.y + Math.sin(this.bob) * 2);

                // Box
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(x, y, 16, 16);
                ctx.strokeStyle = '#ff8c00';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, 16, 16);

                // Letter
                ctx.fillStyle = '#000';
                ctx.font = 'bold 10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(this.type, x + 8, y + 12);
            }

            isOffScreen() {
                return this.x < -16;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4;
                this.life = 20;
                this.color = color;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
            }

            draw() {
                const alpha = this.life / 20;
                ctx.fillStyle = this.color;
                ctx.globalAlpha = alpha;
                ctx.fillRect(Math.floor(this.x), Math.floor(this.y), 2, 2);
                ctx.globalAlpha = 1;
            }
        }

        // Game Objects Arrays
        let player;
        let bullets = [];
        let enemies = [];
        let powerUps = [];
        let particles = [];

        // Create particle explosion
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // Level generation
        function spawnEnemies() {
            if (frame % 120 === 0) {
                const types = ['grunt', 'grunt', 'flying', 'tank'];
                const type = types[Math.floor(Math.random() * types.length)];
                const y = type === 'flying' ? 50 + Math.random() * 100 : CANVAS_HEIGHT - 36;
                enemies.push(new Enemy(CANVAS_WIDTH + 20, y, type));
            }
        }

        // Collision detection
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        // Draw background
        function drawBackground() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, CANVAS_HEIGHT);
            gradient.addColorStop(0, '#1a0a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Parallax mountains
            ctx.fillStyle = '#0a0a1a';
            for (let i = 0; i < 5; i++) {
                const x = ((i * 80 - levelScroll * 0.2) % (CANVAS_WIDTH + 80)) - 40;
                ctx.beginPath();
                ctx.moveTo(x, CANVAS_HEIGHT - 20);
                ctx.lineTo(x + 40, CANVAS_HEIGHT - 80);
                ctx.lineTo(x + 80, CANVAS_HEIGHT - 20);
                ctx.fill();
            }

            // Ground
            ctx.fillStyle = '#2d1b4e';
            ctx.fillRect(0, CANVAS_HEIGHT - 20, CANVAS_WIDTH, 20);
            
            // Ground details
            ctx.fillStyle = '#3d2b5e';
            for (let i = 0; i < CANVAS_WIDTH; i += 20) {
                const x = (i - levelScroll) % CANVAS_WIDTH;
                ctx.fillRect(x, CANVAS_HEIGHT - 20, 10, 5);
            }
        }

        // Game Loop
        function update() {
            if (!gameRunning) return;

            frame++;
            levelScroll += 1;

            // Update player
            player.update();

            // Spawn enemies
            spawnEnemies();

            // Update bullets
            bullets = bullets.filter(b => {
                b.update();
                return !b.isOffScreen();
            });

            // Update enemies
            enemies = enemies.filter(e => {
                e.update();

                // Check bullet collisions
                for (let i = bullets.length - 1; i >= 0; i--) {
                    if (checkCollision(bullets[i], e)) {
                        bullets.splice(i, 1);
                        e.hp--;
                        createParticles(e.x + 8, e.y + 8, 5, '#ff6b6b');

                        if (e.hp <= 0) {
                            score += e.type === 'tank' ? 500 : e.type === 'flying' ? 200 : 100;
                            createParticles(e.x + 8, e.y + 8, 15, '#ff6b6b');
                            
                            // Chance to spawn power-up
                            if (Math.random() < 0.15) {
                                const types = ['S', 'L', 'R'];
                                const type = types[Math.floor(Math.random() * types.length)];
                                powerUps.push(new PowerUp(e.x, e.y, type));
                            }
                            
                            return false;
                        }
                    }
                }

                // Check player collision
                if (checkCollision(player, e)) {
                    if (player.hit()) {
                        lives--;
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('error');
                        }
                        if (lives <= 0) {
                            gameOver();
                        }
                    }
                }

                return !e.isOffScreen();
            });

            // Update power-ups
            powerUps = powerUps.filter(p => {
                p.update();

                if (checkCollision(player, p)) {
                    if (p.type === 'S') player.weapon = 'spread';
                    else if (p.type === 'L') player.weapon = 'laser';
                    else if (p.type === 'R') player.weapon = 'rapid';
                    else if (p.type === '1UP') lives++;

                    score += 50;
                    createParticles(p.x + 8, p.y + 8, 10, '#ffd700');
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                    return false;
                }

                return !p.isOffScreen();
            });

            // Update particles
            particles = particles.filter(p => {
                p.update();
                return p.life > 0;
            });

            // Update HUD
            document.getElementById('score').textContent = score.toString().padStart(6, '0');
            document.getElementById('lives').textContent = lives;
            document.getElementById('weapon').textContent = player.weapon === 'normal' ? 'N' : player.weapon.toUpperCase()[0];
        }

        function draw() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            drawBackground();

            // Draw game objects
            powerUps.forEach(p => p.draw());
            enemies.forEach(e => e.draw());
            bullets.forEach(b => b.draw());
            if (player) player.draw();
            particles.forEach(p => p.draw());
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameRunning = true;
            score = 0;
            lives = 3;
            frame = 0;
            levelScroll = 0;

            player = new Player();
            bullets = [];
            enemies = [];
            powerUps = [];
            particles = [];

            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('game-over').style.display = 'none';
        }

        function gameOver() {
            gameRunning = false;
            document.getElementById('final-score').textContent = 'SCORE: ' + score.toString().padStart(6, '0');
            document.getElementById('game-over').style.display = 'flex';

            // Save high score
            if (tg?.CloudStorage) {
                tg.CloudStorage.getItem('avaforce_highscore', (err, val) => {
                    const highScore = val ? parseInt(val) : 0;
                    if (score > highScore) {
                        tg.CloudStorage.setItem('avaforce_highscore', score.toString());
                    }
                });
            }
        }

        // Event Listeners
        document.getElementById('start-btn').addEventListener('click', () => {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            startGame();
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            startGame();
        });

        // Start game loop
        gameLoop();
    </script>
</body>
</html>
